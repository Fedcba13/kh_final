<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="marketOwner">
	
	<insert id="insertMarketFounded">
		insert into market
		values('mar'||LPAD(seq_market_no.nextval, 5, '0'), 
		#{memberId}, default, #{marketTelephone}, 
		#{marketAddress}, #{marketAddress2}, 1, default, default, default, default)
	</insert>
	
	<update id="updateMemberFounded">
		update member
		set member_check=2
		where member_id=#{memberId}
	</update>
	
	<select id="selectByMemberId" resultMap="marketAndMember">
		select *
		from market join member using (member_id)
		where member_id=#{memberId} and market_enabled=1
	</select>
	<resultMap type="marketMember" id="marketAndMember">
		<id column="member_id" property="memberId"/>
		<result column="market_no" property="marketNo"/>
		<result column="market_resident" property="marketResident"/>
		<result column="market_telephone" property="marketTelephone"/>
		<result column="market_address" property="marketAddress"/>
		<result column="market_address2" property="marketAddress2"/>
		<result column="market_enabled" property="marketEnabled"/>
		<result column="flag" property="flag"/>
		<result column="market_name" property="marketName"/>
		<result column="market_holiday" property="marketHoliday"/>
		<result column="market_time" property="marketTime"/>
		<association javaType="member" property="member">
			<id column="member_id" property="memberId"/>
		    <result column="member_password" property="memberPassword"/>
		    <result column="member_name" property="memberName"/>
		    <result column="member_point" property="memberPoint"/>
		    <result column="member_address" property="memberAddress"/>
		    <result column="member_address2" property="memberAddress2"/>
		    <result column="member_phone" property="memberPhone"/>
		    <result column="member_enrolldate" property="memberEnrolldate"/>
		    <result column="member_check" property="memberCheck"/>
		    <result column="member_enabled" property="memberEnabled"/>
		</association>
	</resultMap>
	
	<update id="updateMarketFounded">
		update market 
		set market_telephone=#{marketTelephone}, market_address=#{marketAddress}, market_address2=#{marketAddress2}
		where member_id=#{memberId}
	</update>
	
	<update id="cancelFounded">
		update market 
		set market_enabled=0
		where market_no=#{marketNo}
	</update>
	
	<select id="selectMarketList" resultType="market">
		select * from market
		<trim prefix="where" suffixOverrides="and">
			market_enabled=1
			<if test="flag!=null and flag!=''">
			and flag=#{flag}
			</if>
			<if test="marketNo!=null and marketNo!=''">
			and market_no=#{marketNo}
			</if>
			<if test="marketAddress!=null and marketAddress!=''">
			and market_address like '%'||#{marketAddress}||'%'
			</if>
		</trim>
		order by market_no desc
	</select>

	<update id="updateMemberCancelFounded">
		update member
		set member_check=1
		where member_id=#{memberId}
	</update>
	
	<update id="myMarketUpdate">
		update market
		set market_telephone=#{marketTelephone}, market_holiday=#{marketHoliday}, market_time=#{marketTime}
		where market_no=#{marketNo}
	</update>
	
	<update id="myMarketOpen">
		update market
		set flag=2
		where market_no=#{marketNo}
	</update>
	
	<select id="selectEventList" resultType="event">
		select * from event
		<trim prefix="where" suffixOverrides="or">
			event_enabled=1
			<if test="marketNo!=null and marketNo!=''">
			and market_no is null
			or market_no=#{marketNo}
			</if>
		</trim>
	</select>
	
	<select id="searchMarketList" resultType="market">
		select * from market
		where market_enabled=1 and flag=#{flag} and market_address like '%'||#{marketAddress}||'%'
		order by market_no desc
	</select>
	
	<select id="eventCompanySearch" resultType="string">
		select distinct food_company
		from food
		where food_company like '%'||#{srchCompany}||'%'
	</select>
	
	<select id="eventSearchCategory" resultType="map">
		select distinct S.food_section_name name, F.food_section_no no
		from food F left join food_section S on F.food_section_no=S.food_section_no
		where F.food_company like '%'||#{srchCompany}||'%'
		and S.food_section_name like '%'||#{eventCategory}||'%'
	</select>
	
	
	<resultMap type="foodWithFoodSection" id="foodWithFoodSection">
		<id column="food_no" property="foodNo"/>
		<result column="food_name" property="foodName"/>
		<result column="food_section_no" property="foodSectionNo"/>
		<result column="food_company" property="foodCompany"/>
		<result column="food_market_price" property="foodMarketPrice"/>
		<result column="food_member_price" property="foodMemberPrice"/>
		<result column="food_enabled" property="foodEnabled"/>
		<result column="food_img" property="foodImg"/>
		<collection property="foodSectionList" ofType="foodSection">
			<id column="food_section_no" property="foodSectionNo"/>
			<result column="food_division_no" property="foodDivisionNo"/>
			<result column="food_section_name" property="foodSectionName"/>
			<result column="food_section_upper" property="foodSectionUpper"/>
		</collection>
	</resultMap>
	
	<select id="selectMarketNoByMemberId" resultType="string">
		select market_no from market 
		where member_id=#{memberId} and market_enabled=1
	</select>
	
	<!-- 
	<select id="selectFoodStockList" resultType="map">
		select *
		from food F left join stock S using(food_no)
		where market_no=#{marketNo}
		order by food_no desc
	</select>
	 -->
	
	<select id="selectFoodStockList" resultType="map">
		select *
		from food F left join stock S on F.food_no=S.food_no
		left join food_section D on F.food_section_no=D.food_section_no
		<trim prefix="where" suffixOverrides="and">
			S.market_no=#{marketNo}
			<if test="foodDivision!=null and foodDivision!=''">
			and food_division_no=#{foodDivision}
			</if>
			<if test="foodOrderSearchType=='food_name'">
			and F.food_name like '%'||#{foodOrderSearchKeyword}||'%'
			</if>
			<if test="foodOrderSearchType=='food_no'">
			and F.food_no like '%'||#{foodOrderSearchKeyword}||'%'
			</if>
		</trim>
		order by F.food_no desc
	</select>
	
	<select id="selectTotalContents" resultType="_int">
		select count(*)
		from food F left join stock S on F.food_no=S.food_no
		left join food_section D on F.food_section_no=D.food_section_no
		<trim prefix="where" suffixOverrides="and">
			S.market_no=#{marketNo}
			<if test="foodDivision!=null and foodDivision!=''">
			and food_division_no=#{foodDivision}
			</if>
			<if test="foodOrderSearchType=='food_name'">
			and F.food_name like '%'||#{foodOrderSearchKeyword}||'%'
			</if>
			<if test="foodOrderSearchType=='food_no'">
			and F.food_no like '%'||#{foodOrderSearchKeyword}||'%'
			</if>
		</trim>
		order by F.food_no desc
	</select>
	
	<select id="selectFoodDivision" resultType="foodDivision">
		select * from food_division
	</select>
	
	<insert id="insertMarketOrderCart">
		insert into cart
		values (#{memberId}, #{foodNo}, #{marketOrderDetailAmount}, 2)
	</insert>
	
	<select id="checkMarketCart" resultType="cart">
		select * from cart
		where member_id=#{memberId} and food_no=#{foodNo} and flag=2
	</select>
	
	<update id="updateMarketOrderCart">
		update cart
		set cart_amount=#{marketOrderDetailAmount}
		where member_id=#{memberId} and food_no=#{foodNo} and flag=2
	</update>
	
	<select id="selectMarketCartList" resultType="map">
		select C.*, F.food_name, F.food_market_price, F.food_company
		from cart C left join food F on C.food_no=F.food_no
		where C.member_id=#{memberId} and C.flag=2
	</select>
	
	<select id="selectCartTotalContents" resultType="_int">
		select count(*) 
		from cart
		where member_id=#{memberId} and flag=2
		order by food_no desc
	</select>
	
	<delete id="delMarketOrderCart">
		delete from cart
		where member_id=#{memberId} and flag=2 and food_no=#{foodNo}
	</delete>
	
</mapper>